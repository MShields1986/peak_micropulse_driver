name: Tests

on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libboost-system-dev libgtest-dev

      - name: Configure
        run: cmake -B build -DBUILD_PeakMicroPulse_TESTS=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run tests
        run: ctest --test-dir build -E '(Memcheck|Helgrind)' --output-on-failure

  asan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libboost-system-dev libgtest-dev

      - name: Configure with ASan
        run: cmake -B build -DBUILD_PeakMicroPulse_TESTS=ON -DENABLE_ASAN=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run tests under ASan
        run: ctest --test-dir build -E '(Memcheck|Helgrind)' --output-on-failure

  tsan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libboost-system-dev libgtest-dev

      - name: Configure with TSan
        run: cmake -B build -DBUILD_PeakMicroPulse_TESTS=ON -DENABLE_TSAN=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run tests under TSan
        run: ctest --test-dir build -E '(Memcheck|Helgrind)' --output-on-failure

  valgrind:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libboost-system-dev libgtest-dev valgrind

      - name: Configure
        run: cmake -B build -DBUILD_PeakMicroPulse_TESTS=ON -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run Valgrind memcheck
        run: ctest --test-dir build -R Memcheck --output-on-failure --timeout 300

      # Helgrind disabled: it does not understand C++11 std::atomic and
      # reports false-positive races.  TSan (above) covers thread safety.
      # - name: Run Helgrind
      #   run: ctest --test-dir build -R Helgrind --output-on-failure --timeout 300
